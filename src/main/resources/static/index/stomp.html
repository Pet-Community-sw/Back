<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>STOMP ì¸ì¦ í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        #chat {
            border: 1px solid #ccc;
            height: 300px;
            overflow-y: scroll;
            padding: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
<h2>ğŸ” STOMP ì¸ì¦ í…ŒìŠ¤íŠ¸</h2>

<div>
    JWT í† í°:
    <input type="text" id="jwtToken" size="60" placeholder="Bearer eyJhbGciOi...">
</div>
<div>
    ì±„íŒ…ë°© ID:
    <input type="number" id="chatRoomId" value="1">
</div>
<div>
    ì‚¬ìš©ì ID:
    <input type="number" id="senderId" value="101">
</div>
<button onclick="sendLeaveMessage()">ë°© ë‚˜ê°€ê¸°</button>

<button onclick="connectAndEnterRoom()">ì„œë²„ ì—°ê²° ë° ì±„íŒ…ë°© ì…ì¥</button>

<div id="connectStatus">â›” ì—°ê²° ì•ˆ ë¨</div>
<div id="chat"></div>

<input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
<button onclick="sendMessage()">ë³´ë‚´ê¸°</button>

<script>
    let stompClient = null;

    function connectAndEnterRoom() {
        const token = document.getElementById("jwtToken").value.trim();
        const chatRoomId = document.getElementById("chatRoomId").value;

        const socket = new SockJS("http://localhost:8080/ws-stomp");
        stompClient = Stomp.over(socket);

        stompClient.connect(
            {
                Authorization: token
            },
            function (frame) {
                document.getElementById("connectStatus").innerText = "âœ… ì„œë²„ ì—°ê²°ë¨";

                stompClient.subscribe("/sub/chat/" + chatRoomId, function (message) {
                    const msg = JSON.parse(message.body);
                    const chatBox = document.getElementById("chat");
                    // senderName ì œê±° â†’ ëŒ€ì‹  senderId í‘œì‹œ
                    chatBox.innerHTML += `<div><b>ğŸ‘¤${msg.senderId}:</b> ${msg.message}</div>`;
                    chatBox.scrollTop = chatBox.scrollHeight;
                });

                // ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
                const enterMessage = {
                    messageType: "ENTER",
                    chatRoomId: Number(chatRoomId),
                    senderId: Number(document.getElementById("senderId").value),
                    message: ""
                };
                console.log(enterMessage);
                stompClient.send("/pub/chat/message", {}, JSON.stringify(enterMessage));
            },
            function (error) {
                console.error("ì—°ê²° ì‹¤íŒ¨", error);
                document.getElementById("connectStatus").innerText = "âŒ ì—°ê²° ì‹¤íŒ¨";
            }
        );
    }
    function sendLeaveMessage() {
        const chatRoomId = document.getElementById("chatRoomId").value;
        const senderId = document.getElementById("senderId").value;

        if (!stompClient || !stompClient.connected) {
            alert("ì•„ì§ ì„œë²„ì— ì—°ê²°ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        const leaveMessage = {
            messageType: "LEAVE",
            chatRoomId: Number(chatRoomId),
            senderId: Number(senderId),
            message: ""
        };

        stompClient.send("/pub/chat/message", {}, JSON.stringify(leaveMessage));
        stompClient.disconnect(() => {
            document.getElementById("connectStatus").innerText = "ğŸšª ë‚˜ê°”ìŠµë‹ˆë‹¤ (ì—°ê²° ì¢…ë£Œ)";
            console.log("Disconnected from STOMP");
        });
    }

    function sendMessage() {
        const chatRoomId = document.getElementById("chatRoomId").value;
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value;

        if (!message) return;

        const msgObj = {
            messageType: "TALK",
            chatRoomId: Number(chatRoomId),
            senderId: Number(document.getElementById("senderId").value),
            message: message
        };
        console.log(JSON.stringify(msgObj));
        stompClient.send("/pub/chat/message", {}, JSON.stringify(msgObj));
        messageInput.value = "";
    }
</script>
</body>
</html>
